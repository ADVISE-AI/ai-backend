2025-11-20T23:43:45,643 INFO     [db.py:36] Initializing database for PID 86210
2025-11-20T23:43:45,806 INFO     [db.py:80] ✅ Database initialized for PID 86210 (pool_size=5, max_overflow=10)
2025-11-20T23:43:46,604 INFO     [bot.py:314] Gemini system prompt loaded successfully
2025-11-20T23:43:47,271 INFO     [bot.py:327] Gemini model initialized successfully
2025-11-20T23:43:47,273 INFO     [bot.py:414] LangGraph graph built successfully
2025-11-20T23:43:47,273 INFO     [bot.py:534] bot.py module loaded successfully
2025-11-20T23:43:47,353 INFO     [message_deduplicator.py:15] Connecting to Redis at localhost:6379
2025-11-20T23:43:47,355 INFO     [message_deduplicator.py:18] ✅ Redis connection established
2025-11-20T23:43:47,377 DEBUG    [functional.py:335] 
def chain(*args, **kwargs):
    return 1

2025-11-20T23:43:47,378 DEBUG    [functional.py:335] 
def xstarmap(task, it):
    return 1

2025-11-20T23:43:47,378 DEBUG    [functional.py:335] 
def update_message_status_task(status_data):
    return 1

2025-11-20T23:43:47,378 DEBUG    [functional.py:335] 
def accumulate(self, *args, **kwargs):
    return 1

2025-11-20T23:43:47,379 DEBUG    [functional.py:335] 
def chord(self, header, body, partial_args=0, interval=1, countdown=2, max_retries=3, eager=4, **kwargs):
    return 1

2025-11-20T23:43:47,379 DEBUG    [functional.py:335] 
def chunks(task, it, n):
    return 1

2025-11-20T23:43:47,379 DEBUG    [functional.py:335] 
def unlock_chord(self, group_id, callback, interval=0, max_retries=1, result=2, Result=3, GroupResult=4, result_from_tuple=5, **kwargs):
    return 1

2025-11-20T23:43:47,380 DEBUG    [functional.py:335] 
def process_message_task(self, normalized_data):
    return 1

2025-11-20T23:43:47,380 DEBUG    [functional.py:335] 
def check_buffer_task(phone):
    return 1

2025-11-20T23:43:47,380 DEBUG    [functional.py:335] 
def group(self, tasks, result, group_id, partial_args, add_to_parent=0):
    return 1

2025-11-20T23:43:47,381 DEBUG    [functional.py:335] 
def update_langgraph_state_task(self, phone, updates):
    return 1

2025-11-20T23:43:47,381 DEBUG    [functional.py:335] 
def xmap(task, it):
    return 1

2025-11-20T23:43:47,381 DEBUG    [functional.py:335] 
def cleanup_old_media_task():
    return 1

2025-11-20T23:43:47,381 DEBUG    [functional.py:335] 
def backend_cleanup():
    return 1

2025-11-20T23:43:47,382 DEBUG    [functional.py:335] 
def sync_operator_message_to_graph_task(self, phone, message_text):
    return 1

 
 -------------- celery@engima v5.5.3 (immunity)
--- ***** ----- 
-- ******* ---- Linux-6.17.8-arch1-1-x86_64-with-glibc2.42 2025-11-20 23:43:47
- *** --- * --- 
- ** ---------- [config]
- ** ---------- .> app:         webhook:0x7f73042770e0
- ** ---------- .> transport:   redis://default:**@localhost:6379//
- ** ---------- .> results:     redis://default:**@localhost:6379/
- *** --- * --- .> concurrency: 4 (prefork)
-- ******* ---- .> task events: ON
--- ***** ----- 
 -------------- [queues]
                .> default          exchange=default(direct) key=default
                .> media            exchange=media(direct) key=media
                .> messages         exchange=messages(direct) key=messages
                .> state            exchange=state(direct) key=state
                .> status           exchange=status(direct) key=status

[tasks]
  . tasks.check_buffer
  . tasks.cleanup_old_media
  . tasks.process_message
  . tasks.sync_operator_message_to_graph
  . tasks.update_langgraph_state
  . tasks.update_message_status

[2025-11-20 23:43:47,875: INFO/MainProcess] Connected to redis://default:**@localhost:6379//
[2025-11-20 23:43:47,878: INFO/MainProcess] mingle: searching for neighbors
[2025-11-20 23:43:48,891: INFO/MainProcess] mingle: all alone
[2025-11-20 23:43:48,916: INFO/MainProcess] celery@engima ready.
[2025-11-20 23:45:19,038: INFO/MainProcess] Task tasks.check_buffer[7a1d8ce4-8651-44a9-a653-55a3c0fb5ff9] received
[2025-11-20 23:45:21,024: INFO/ForkPoolWorker-3] Message buffer Redis connection established
[2025-11-20 23:45:21,024: INFO/ForkPoolWorker-3] Created new message buffer instance
[2025-11-20 23:45:21,025: INFO/ForkPoolWorker-3] Checking buffer for 917980977361
[2025-11-20 23:45:21,025: INFO/ForkPoolWorker-3] Debounce time reached for 917980977361 (2.0s)
[2025-11-20 23:45:21,025: INFO/ForkPoolWorker-3] Retrieved 1 messages for 917980977361
[2025-11-20 23:45:21,026: INFO/ForkPoolWorker-3] Processing 1 buffered messages for 917980977361
[2025-11-20 23:45:21,033: INFO/MainProcess] Task tasks.process_message[4a87c053-20ba-4c5b-9536-a5551818f69f] received
[2025-11-20 23:45:21,034: INFO/ForkPoolWorker-3] Task tasks.check_buffer[7a1d8ce4-8651-44a9-a653-55a3c0fb5ff9] succeeded in 0.013609133999125334s: None
[2025-11-20 23:45:21,037: INFO/ForkPoolWorker-1] [Celery-4a87c053] Processing wamid.HBgMOTE3OTgwOTc3MzYxFQIAEhgWM0VCMEI4Q0ZFQTQ4REUxQzA3MkNGQgA= from 917980977361
[2025-11-20 23:45:21,041: INFO/ForkPoolWorker-1] Processing message for conversation ID: 1
[2025-11-20 23:45:21,048: INFO/ForkPoolWorker-1] Text for AI processing - Message: Heyyy
[2025-11-20 23:45:21,048: INFO/ForkPoolWorker-1] Content formatted in 0.00s for 917980977361
[2025-11-20 23:45:21,049: INFO/ForkPoolWorker-1] Creating LangGraph checkpointer for PID 86248
[2025-11-20 23:45:21,064: INFO/ForkPoolWorker-1] LangGraph connection test successful
[2025-11-20 23:45:21,065: INFO/ForkPoolWorker-1] LangGraph DB setup successful
[2025-11-20 23:45:21,066: INFO/ForkPoolWorker-1] ✅ LangGraph checkpointer ready for PID 86248
[2025-11-20 23:45:24,072: INFO/ForkPoolWorker-1] Gemini raw response: AIMessage(content=[{'type': 'text', 'text': 'Namaste! Maine aapko samples bheje hain. Aapko kaunsa type pasand aaya? AI, 3D ya 2D?', 'extras': {'signature': 'CuQBAdHtim/gt9xqXHqow1GUtgz1F42SnXp/sTOad6HpzsLjY9MrT8Y37NPACBeP3b2ZdSP1+zRS1TCWIaUk1kO67DanleJ3ZuGoWWaVfNaUH19zes8QlxL4P901cud3z84LTD7m2BYa/rm8+tVEJYKOzzbyqstcMlLu37I0+GtPt5kxMp04mwZrDFoYNeFKn6W2SRkqiC27tjcZ+gEwkck6asaJJFE0aOTX/2ygP+TwI6oMJSDX4NCj39mJbRbNNOG2yuKIMIR2Nl5fJ9fEHzyJmotzIIrvRqvo+Bp6eWbHre9OMsmF'}}], additional_kwargs={}, response_metadata={'prompt_feedback': {'block_reason': 0, 'safety_ratings': []}, 'finish_reason': 'STOP', 'model_name': 'gemini-2.5-flash', 'safety_ratings': [], 'model_provider': 'google_genai'}, id='lc_run--e43fefa8-0657-4397-bf6d-7eb23e4ab80e-0', usage_metadata={'input_tokens': 6942, 'output_tokens': 67, 'total_tokens': 7009, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 37}})
[2025-11-20 23:45:24,077: INFO/ForkPoolWorker-1] AI processing complete for 917980977361: 3.00s (1 turns), Total: 3.03s
[2025-11-20 23:45:24,077: INFO/ForkPoolWorker-1] Final response for 917980977361 after 1 turns: 1 chars
Response: [{'type': 'text', 'text': 'Namaste! Maine aapko samples bheje hain. Aapko kaunsa type pasand aaya? AI, 3D ya 2D?', 'extras': {'signature': 'CuQBAdHtim/gt9xqXHqow1GUtgz1F42SnXp/sTOad6HpzsLjY9MrT8Y37NPACBeP3b2ZdSP1+zRS1TCWIaUk1kO67DanleJ3ZuGoWWaVfNaUH19zes8QlxL4P901cud3z84LTD7m2BYa/rm8+tVEJYKOzzbyqstcMlLu37I0+GtPt5kxMp04mwZrDFoYNeFKn6W2SRkqiC27tjcZ+gEwkck6asaJJFE0aOTX/2ygP+TwI6oMJSDX4NCj39mJbRbNNOG2yuKIMIR2Nl5fJ9fEHzyJmotzIIrvRqvo+Bp6eWbHre9OMsmF'}}]...
[2025-11-20 23:45:25,071: INFO/ForkPoolWorker-1] Typing indicator response: 200
[2025-11-20 23:45:25,072: INFO/ForkPoolWorker-1] Typing indicator sent for message wamid.HBgMOTE3OTgwOTc3MzYxFQIAEhgWM0VCMEI4Q0ZFQTQ4REUxQzA3MkNGQgA=
[2025-11-20 23:45:31,069: INFO/ForkPoolWorker-1] Message send response: 400
[2025-11-20 23:45:31,069: WARNING/ForkPoolWorker-1] --- Logging error ---
[2025-11-20 23:45:31,081: WARNING/ForkPoolWorker-1] Traceback (most recent call last):
[2025-11-20 23:45:31,082: WARNING/ForkPoolWorker-1]   File "/usr/lib/python3.13/logging/__init__.py", line 1151, in emit
    msg = self.format(record)
[2025-11-20 23:45:31,083: WARNING/ForkPoolWorker-1]   File "/usr/lib/python3.13/logging/__init__.py", line 999, in format
    return fmt.format(record)
           ~~~~~~~~~~^^^^^^^^
[2025-11-20 23:45:31,083: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/utils/log.py", line 146, in format
    msg = super().format(record)
[2025-11-20 23:45:31,083: WARNING/ForkPoolWorker-1]   File "/usr/lib/python3.13/logging/__init__.py", line 712, in format
    record.message = record.getMessage()
                     ~~~~~~~~~~~~~~~~~^^
[2025-11-20 23:45:31,083: WARNING/ForkPoolWorker-1]   File "/usr/lib/python3.13/logging/__init__.py", line 400, in getMessage
    msg = msg % self.args
          ~~~~^~~~~~~~~~~
[2025-11-20 23:45:31,083: WARNING/ForkPoolWorker-1] TypeError: not all arguments converted during string formatting
[2025-11-20 23:45:31,083: WARNING/ForkPoolWorker-1] Call stack:
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/bin/celery", line 7, in <module>
    sys.exit(main())
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/__main__.py", line 15, in main
    sys.exit(_main())
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/bin/celery.py", line 231, in main
    return celery(auto_envvar_prefix="CELERY")
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/click/core.py", line 1485, in __call__
    return self.main(*args, **kwargs)
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/click/core.py", line 1406, in main
    rv = self.invoke(ctx)
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/click/core.py", line 1873, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/click/core.py", line 1269, in invoke
    return ctx.invoke(self.callback, **ctx.params)
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/click/core.py", line 824, in invoke
    return callback(*args, **kwargs)
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/click/decorators.py", line 34, in new_func
    return f(get_current_context(), *args, **kwargs)
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/bin/base.py", line 135, in caller
    return f(ctx, *args, **kwargs)
[2025-11-20 23:45:31,124: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/bin/worker.py", line 356, in worker
    worker.start()
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/worker/worker.py", line 203, in start
    self.blueprint.start(self)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/bootsteps.py", line 116, in start
    step.start(parent)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/bootsteps.py", line 365, in start
    return self.obj.start()
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/concurrency/base.py", line 130, in start
    self.on_start()
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/concurrency/prefork.py", line 109, in on_start
    P = self._pool = Pool(processes=self.limit,
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/concurrency/asynpool.py", line 473, in __init__
    super().__init__(processes, *args, **kwargs)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/pool.py", line 1046, in __init__
    self._create_worker_process(i)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/concurrency/asynpool.py", line 491, in _create_worker_process
    return super()._create_worker_process(i)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/pool.py", line 1158, in _create_worker_process
    w.start()
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/process.py", line 120, in start
    self._popen = self._Popen(self)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/context.py", line 331, in _Popen
    return Popen(process_obj)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/popen_fork.py", line 22, in __init__
    self._launch(process_obj)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/popen_fork.py", line 77, in _launch
    code = process_obj._bootstrap()
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/process.py", line 323, in _bootstrap
    self.run()
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/process.py", line 110, in run
    self._target(*self._args, **self._kwargs)
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/pool.py", line 292, in __call__
    sys.exit(self.workloop(pid=pid))
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/billiard/pool.py", line 362, in workloop
    result = (True, prepare_result(fun(*args, **kwargs)))
[2025-11-20 23:45:31,125: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/app/trace.py", line 651, in fast_trace_task
    R, I, T, Rstr = tasks[task].__trace__(
[2025-11-20 23:45:31,126: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
[2025-11-20 23:45:31,126: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/app/trace.py", line 736, in __protected_call__
    return self.run(*args, **kwargs)
[2025-11-20 23:45:31,126: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/.venv/lib/python3.13/site-packages/celery/app/autoretry.py", line 38, in run
    return task._orig_run(*args, **kwargs)
[2025-11-20 23:45:31,126: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/tasks.py", line 235, in process_message_task
    message_router(normalized_data)
[2025-11-20 23:45:31,126: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/utility/message_router.py", line 71, in message_router
    handle_with_ai(normalized_data, conversation_id)
[2025-11-20 23:45:31,126: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/utility/handle_with_ai.py", line 26, in handle_with_ai
    response = send_message(clean_data["from"]["phone"], ai_message)
[2025-11-20 23:45:31,126: WARNING/ForkPoolWorker-1]   File "/home/darkus/Desktop/AdviseProject/ai-backend/utility/whatsapp/messaging.py", line 50, in send_message
    _logger.error("Failed to send message. Status: %s", response.status_code,f"\n Payload: {json.dumps(data, indent=2)}")
[2025-11-20 23:45:31,126: WARNING/ForkPoolWorker-1] Message: 'Failed to send message. Status: %s'
Arguments: (400, '\n Payload: {\n  "messaging_product": "whatsapp",\n  "to": "917980977361",\n  "type": "text",\n  "text": {\n    "body": [\n      {\n        "type": "text",\n        "text": "Namaste! Maine aapko samples bheje hain. Aapko kaunsa type pasand aaya? AI, 3D ya 2D?",\n        "extras": {\n          "signature": "CuQBAdHtim/gt9xqXHqow1GUtgz1F42SnXp/sTOad6HpzsLjY9MrT8Y37NPACBeP3b2ZdSP1+zRS1TCWIaUk1kO67DanleJ3ZuGoWWaVfNaUH19zes8QlxL4P901cud3z84LTD7m2BYa/rm8+tVEJYKOzzbyqstcMlLu37I0+GtPt5kxMp04mwZrDFoYNeFKn6W2SRkqiC27tjcZ+gEwkck6asaJJFE0aOTX/2ygP+TwI6oMJSDX4NCj39mJbRbNNOG2yuKIMIR2Nl5fJ9fEHzyJmotzIIrvRqvo+Bp6eWbHre9OMsmF"\n        }\n      }\n    ]\n  }\n}')
[2025-11-20 23:45:31,126: ERROR/ForkPoolWorker-1] Error response: {
  "error": {
    "message": "(#100) Param text['body'] must be a string.",
    "type": "OAuthException",
    "code": 100,
    "fbtrace_id": "Aw5Q07DjhW777tQSskMZoo8"
  }
}
[2025-11-20 23:45:31,128: ERROR/ForkPoolWorker-1] Database error: 'messages'
[2025-11-20 23:45:31,128: INFO/ForkPoolWorker-1] [Celery-4a87c053] Completed wamid.HBgMOTE3OTgwOTc3MzYxFQIAEhgWM0VCMEI4Q0ZFQTQ4REUxQzA3MkNGQgA=
[2025-11-20 23:45:31,130: INFO/ForkPoolWorker-1] Task tasks.process_message[4a87c053-20ba-4c5b-9536-a5551818f69f] succeeded in 10.095696127000338s: {'status': 'success', 'phone': '917980977361', 'message_id': 'wamid.HBgMOTE3OTgwOTc3MzYxFQIAEhgWM0VCMEI4Q0ZFQTQ4REUxQzA3MkNGQgA=', 'task_id': '4a87c053-20ba-4c5b-9536-a5551818f69f'}

worker: Warm shutdown (MainProcess)
